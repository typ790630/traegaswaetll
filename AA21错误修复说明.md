# ğŸ”§ AA21 é”™è¯¯ä¿®å¤è¯´æ˜

## ğŸ”´ é—®é¢˜åˆ†æ

### **é”™è¯¯ä¿¡æ¯**
```
UserOperation reverted during simulation with reason: AA21 didn't pay prefund
```

### **é”™è¯¯åŸå› **

ä½ çš„ä¿®æ”¹ä½¿ç”¨äº† `client.sendTransaction()`ï¼š
```typescript
const txHash = await client.sendTransaction({  // âŒ é”™è¯¯
    to: client.account.address,
    data: batchData,
    value: 0n
})
```

**ä¸ºä»€ä¹ˆå¤±è´¥**ï¼š
1. âŒ `sendTransaction` æ˜¯**æ™®é€šäº¤æ˜“**æ–¹æ³•
2. âŒ **ä¸ä¼šè§¦å‘ Paymaster middleware**
3. âŒ EntryPoint è¦æ±‚è´¦æˆ·é¢„ä»˜ gasï¼ˆprefundï¼‰
4. âŒ ä½†è´¦æˆ·æ²¡æœ‰è¶³å¤Ÿçš„ prefundï¼ˆå³ä½¿æœ‰ BNBï¼‰
5. âŒ å¯¼è‡´ AA21 é”™è¯¯

---

## ğŸ“Š **ä¸¤ç§æ–¹æ³•å¯¹æ¯”**

### **âŒ sendTransactionï¼ˆä½ çš„ä¿®æ”¹ï¼‰**
```typescript
client.sendTransaction({
    to: address,
    data: data,
    value: 0n
})
```

**ç‰¹ç‚¹**ï¼š
- æ™®é€šçš„ä»¥å¤ªåŠäº¤æ˜“
- **ä¸ç»è¿‡** Paymaster middleware
- **ä¸æ”¯æŒ** UserOperation
- **ä¸æ”¯æŒ** ERC-4337
- **éœ€è¦** è´¦æˆ·æœ‰è¶³å¤Ÿçš„ prefund

**ç»“æœ**ï¼š
- âŒ AA21 é”™è¯¯
- âŒ Paymaster æ— æ³•å·¥ä½œ
- âŒ å³ä½¿æœ‰ BNB ä¹Ÿå¤±è´¥

---

### **âœ… sendUserOperationï¼ˆæ­£ç¡®æ–¹æ³•ï¼‰**
```typescript
client.sendUserOperation({
    calls: [
        { to: address1, data: data1, value: 0n },
        { to: address2, data: data2, value: 0n }
    ]
})
```

**ç‰¹ç‚¹**ï¼š
- ERC-4337 æ ‡å‡†çš„ UserOperation
- **è‡ªåŠ¨è§¦å‘** Paymaster middleware
- **æ”¯æŒ** æ‰¹é‡è°ƒç”¨
- **æ”¯æŒ** gas èµåŠ©

**ç»“æœ**ï¼š
- âœ… Paymaster æ­£å¸¸å·¥ä½œ
- âœ… å¯ä»¥å…è´¹æˆ–ç”¨ RADRS æ”¯ä»˜
- âœ… å¯ä»¥å›é€€åˆ° BNB æ”¯ä»˜
- âœ… äº¤æ˜“æˆåŠŸ

---

## ğŸ”§ **ä¿®å¤å†…å®¹**

### **ä¿®å¤å‰ï¼ˆä½ çš„ç‰ˆæœ¬ï¼‰**
```typescript
// âŒ ä½¿ç”¨ executeBatch + sendTransaction
const batchData = encodeFunctionData({
    abi: SIMPLE_ACCOUNT_ABI,
    functionName: 'executeBatch',
    args: [...]
})

const txHash = await client.sendTransaction({
    to: client.account.address,
    data: batchData,
    value: 0n
})
```

**é—®é¢˜**ï¼š
- ä¸è§¦å‘ Paymaster
- AA21 é”™è¯¯

---

### **ä¿®å¤åï¼ˆæ­£ç¡®ç‰ˆæœ¬ï¼‰** âœ…
```typescript
// âœ… ä½¿ç”¨ sendUserOperation + calls æ•°ç»„
const userOpHash = await client.sendUserOperation({
    calls: [
        {
            to: RADRS_CONFIG.radrsTokenAddress,
            data: approveData,
            value: 0n
        },
        {
            to: tokenAddress,
            data: transferCallData,
            value: 0n
        }
    ]
})

// ç­‰å¾…äº¤æ˜“ç¡®è®¤
const receipt = await client.waitForUserOperationReceipt({ hash: userOpHash })
return receipt.receipt.transactionHash
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨è§¦å‘ Paymaster
- âœ… æ”¯æŒæ‰¹é‡æ“ä½œ
- âœ… ç¬¦åˆ ERC-4337 æ ‡å‡†
- âœ… æ­£ç¡®å¤„ç† gas

---

## ğŸ’¡ **æŠ€æœ¯åŸç†**

### **ERC-4337 æµç¨‹**

```
ç”¨æˆ·è°ƒç”¨ sendUserOperation
   â†“
SmartAccountClient æ„å»º UserOperation
   â†“
è§¦å‘ Paymaster Middleware âœ…
   â†“
Paymaster æ£€æŸ¥å¹¶èµåŠ© gas
   â†“
Bundler æ‰“åŒ… UserOperation
   â†“
EntryPoint éªŒè¯å¹¶æ‰§è¡Œ
   â†“
âœ… äº¤æ˜“æˆåŠŸ
```

### **ä½ ä¹‹å‰çš„æµç¨‹ï¼ˆsendTransactionï¼‰**

```
ç”¨æˆ·è°ƒç”¨ sendTransaction
   â†“
ç›´æ¥å‘é€æ™®é€šäº¤æ˜“
   â†“
âŒ ä¸è§¦å‘ Paymaster Middleware
   â†“
EntryPoint è¦æ±‚ prefund
   â†“
âŒ prefund ä¸è¶³
   â†“
âŒ AA21 é”™è¯¯
```

---

## ğŸ¯ **ä¸ºä»€ä¹ˆ sendUserOperation æ˜¯æ­£ç¡®çš„ï¼Ÿ**

### **1. ç¬¦åˆ ERC-4337 æ ‡å‡†**
- UserOperation æ˜¯ ERC-4337 çš„æ ¸å¿ƒæ¦‚å¿µ
- æ”¯æŒ gas æŠ½è±¡
- æ”¯æŒ Paymaster

### **2. è‡ªåŠ¨é›†æˆ Paymaster**
- middleware ä¼šè‡ªåŠ¨ä»‹å…¥
- è‡ªåŠ¨å¤„ç† gas èµåŠ©
- è‡ªåŠ¨å›é€€åˆ°ç”¨æˆ·ä»˜è´¹

### **3. æ”¯æŒæ‰¹é‡æ“ä½œ**
- `calls` æ•°ç»„æ”¯æŒå¤šä¸ªæ“ä½œ
- ä¸€æ¬¡ UserOp æ‰§è¡Œå¤šä¸ªè°ƒç”¨
- èŠ‚çœ gas

### **4. æ­£ç¡®çš„ gas è®¡ç®—**
- UserOperation çš„ gas è®¡ç®—æ˜¯å‡†ç¡®çš„
- EntryPoint çŸ¥é“å¦‚ä½•éªŒè¯
- ä¸ä¼šå‡ºç° AA21 é”™è¯¯

---

## ğŸ“‹ **ä¿®å¤æ¸…å•**

- âœ… åˆ é™¤ `SIMPLE_ACCOUNT_ABI`ï¼ˆä¸éœ€è¦ï¼‰
- âœ… åˆ é™¤ `executeBatch` è°ƒç”¨
- âœ… æ”¹ç”¨ `sendUserOperation`
- âœ… ä½¿ç”¨ `calls` æ•°ç»„
- âœ… æ·»åŠ  `waitForUserOperationReceipt`
- âœ… è¿”å›å®é™…çš„äº¤æ˜“å“ˆå¸Œ

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤**

### **1. ç­‰å¾…ä»£ç é‡æ–°åŠ è½½**
- Vite åº”è¯¥è‡ªåŠ¨çƒ­æ›´æ–°
- æˆ–æ‰‹åŠ¨åˆ·æ–°ï¼š`Ctrl + F5`

### **2. å†æ¬¡å°è¯•è½¬è´¦**
- è¾“å…¥æ”¶æ¬¾åœ°å€
- è¾“å…¥é‡‘é¢ï¼ˆå¦‚ 10 RADRSï¼‰
- ç‚¹å‡»ç¡®è®¤

### **3. æ£€æŸ¥æ§åˆ¶å°**

**åº”è¯¥çœ‹åˆ°**ï¼š
```
âœ… Paymaster sponsorship succeeded
Batch UserOperation Sent: Approve Paymaster + Transfer Token
UserOp Hash: 0x...
Transaction confirmed: 0x...
```

**ä¸åº”è¯¥çœ‹åˆ°**ï¼š
```
âŒ AA21 didn't pay prefund
âŒ UserOperation reverted
```

### **4. éªŒè¯ç»“æœ**
- âœ… äº¤æ˜“æˆåŠŸ
- âœ… ä½™é¢æ›´æ–°
- âœ… Activity åˆ—è¡¨æ˜¾ç¤ºæ–°äº¤æ˜“

---

## ğŸ‰ **é¢„æœŸæ•ˆæœ**

### **ä¿®å¤å**

| åœºæ™¯ | ç»“æœ |
|------|------|
| **Paymaster å¯ç”¨** | âœ… ç”¨ Paymasterï¼ˆå…è´¹æˆ– RADRSï¼‰ |
| **Paymaster å¤±è´¥ + æœ‰ BNB** | âœ… è‡ªåŠ¨ç”¨ BNB æ”¯ä»˜ |
| **éƒ½æ²¡æœ‰** | âŒ æ­£å¸¸å¤±è´¥æç¤º |

### **ä¸ä¼šå†å‡ºç°**
- âŒ AA21 é”™è¯¯
- âŒ prefund é—®é¢˜
- âŒ sendTransaction é”™è¯¯

---

## ğŸ“ **æ€»ç»“**

**é—®é¢˜**ï¼šä½¿ç”¨ `sendTransaction` ä¸è§¦å‘ Paymaster

**è§£å†³**ï¼šä½¿ç”¨ `sendUserOperation` + `calls` æ•°ç»„

**ç»“æœ**ï¼š
- âœ… Paymaster æ­£å¸¸å·¥ä½œ
- âœ… æ”¯æŒ BNB å›é€€
- âœ… ç¬¦åˆ ERC-4337 æ ‡å‡†
- âœ… äº¤æ˜“æˆåŠŸ

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026å¹´1æœˆ20æ—¥  
**ä¿®å¤æ–‡ä»¶**ï¼š`src/services/AAService.ts`  
**å…³é”®ä¿®æ”¹**ï¼šç¬¬ 243-261 è¡Œ
