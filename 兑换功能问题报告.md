# å…‘æ¢åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æµ‹è¯•æ—¶é—´: 2026-01-20  
æµ‹è¯•èŒƒå›´: å…‘æ¢é¡µé¢ (src/pages/Swap.tsx)  
æµ‹è¯•ç»“æœ: **å‘ç° 1 ä¸ªä¸¥é‡é”™è¯¯ + 8 ä¸ªè­¦å‘Š**

---

## ğŸ”´ ä¸¥é‡é”™è¯¯ (å¿…é¡»ç«‹å³ä¿®å¤)

### é”™è¯¯ 1: signer å˜é‡æœªå®šä¹‰

**ä½ç½®**: `src/pages/Swap.tsx:106-107`

**ä»£ç **:
```typescript
const txHash = await AAService.swapTokens(
  signer,  // â† ReferenceError: signer is not defined
  PANCAKE_ROUTER,
  ...
)
```

**é—®é¢˜æè¿°**:
- Line 90 è·å–äº†ç§é’¥: `const pk = getPrivateKey()`
- Line 106 ç›´æ¥ä½¿ç”¨ `signer` å˜é‡ï¼Œä½†ä»æœªå£°æ˜
- è¿è¡Œæ—¶ä¼šæŠ›å‡º: `ReferenceError: signer is not defined`

**è§£å†³æ–¹æ¡ˆ**:
åœ¨ Line 91 åæ·»åŠ ä¸€è¡Œä»£ç :
```typescript
const pk = getPrivateKey()
if (!pk) throw new Error("No private key found")

// ã€æ·»åŠ è¿™ä¸€è¡Œã€‘
const signer = AAService.getSigner(pk as `0x${string}`)
```

---

## âš ï¸ è­¦å‘Š (å½±å“åŠŸèƒ½è´¨é‡)

### è­¦å‘Š 2: sendTransactions æ–¹æ³•å¯èƒ½ä¸æ”¯æŒ

**ä½ç½®**: `src/services/AAService.ts:294`

**é—®é¢˜**: permissionless SDK çš„ `sendTransactions` æ–¹æ³•å¯èƒ½ä¸å­˜åœ¨æˆ–ä¸æ”¯æŒæ‰¹é‡äº¤æ˜“

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ permissionless æ–‡æ¡£ç¡®è®¤æ­£ç¡®çš„æ‰¹é‡äº¤æ˜“æ–¹æ³•
- æˆ–ä½¿ç”¨ Multicall åˆçº¦
- æˆ–åˆ†åˆ«å‘é€ä¸¤ç¬”äº¤æ˜“ (approve + swap)

---

### è­¦å‘Š 3: ä½™é¢æ˜¾ç¤ºç¡¬ç¼–ç 

**ä½ç½®**: `src/pages/Swap.tsx:160, 197`

**ä»£ç **:
```typescript
<span>Balance: 0.00</span>  // â† ç¡¬ç¼–ç 
```

**è§£å†³æ–¹æ¡ˆ**:
```typescript
<span>Balance: {fromAsset?.balance || "0.00"}</span>
<span>Balance: {toAsset?.balance || "0.00"}</span>
```

---

### è­¦å‘Š 4: ä½™é¢æ£€æŸ¥ä¸å®Œæ•´

**ä½ç½®**: `src/pages/Swap.tsx:66-67`

**é—®é¢˜**: åªæ£€æŸ¥äº† gas è´¹ï¼Œæ²¡æœ‰æ£€æŸ¥ fromAsset ä½™é¢

**è§£å†³æ–¹æ¡ˆ**:
```typescript
const hasEnoughFromBalance = fromAsset 
  ? parseFloat(fromAsset.balance) >= parseFloat(amount || "0") 
  : false
const hasEnoughGas = gasAsset 
  ? parseFloat(gasAsset.balance) >= parseFloat(finalFee) 
  : false
const canSwap = hasEnoughFromBalance && hasEnoughGas && amount

// åœ¨æŒ‰é’®ä¸­ä½¿ç”¨
<Button disabled={!canSwap || isSwapping}>
```

---

### è­¦å‘Š 5: Gas è´¹æ‰£é™¤é€»è¾‘ç¼ºå¤±

**ä½ç½®**: `src/pages/Swap.tsx:122`

**é—®é¢˜**: äº¤æ˜“æˆåŠŸåæ²¡æœ‰æ‰£é™¤ RADRS gas è´¹

**è§£å†³æ–¹æ¡ˆ**:
åœ¨ `setAmount("")` ä¹‹å‰æ·»åŠ :
```typescript
// æ‰£é™¤ gas è´¹
if (isActivated && parseFloat(finalFee) > 0) {
  updateAssetBalance(network.id, GAS_TOKEN_SYMBOL, finalFee, "subtract")
}

// æ‰£é™¤å…‘æ¢é‡‘é¢
updateAssetBalance(network.id, fromAssetSymbol, amount, "subtract")

setAmount("")
```

---

### è­¦å‘Š 6: æ±‡ç‡æ˜¯ç¡¬ç¼–ç çš„æ¨¡æ‹Ÿå€¼

**ä½ç½®**: `src/pages/Swap.tsx:76, 227`

**ä»£ç **:
```typescript
const estimatedAmount = amount ? (parseFloat(amount) * 0.98).toFixed(4) : ""
// æ±‡ç‡å›ºå®šä¸º 0.98ï¼Œä¸æ˜¯çœŸå®æ±‡ç‡
```

**è§£å†³æ–¹æ¡ˆ**:
ä» PancakeSwap Router è·å–çœŸå®æ±‡ç‡:
```typescript
const getQuote = async () => {
  if (!amount || !fromAsset || !toAsset) return ""
  
  const amounts = await publicClient.readContract({
    address: PANCAKE_ROUTER,
    abi: parseAbi([
      'function getAmountsOut(uint amountIn, address[] path) view returns (uint[] amounts)'
    ]),
    functionName: "getAmountsOut",
    args: [
      parseEther(amount), 
      [fromAsset.contractAddress, toAsset.contractAddress]
    ]
  })
  
  return formatEther(amounts[1])
}
```

---

### è­¦å‘Š 7: ç¼ºå°‘äº¤æ˜“ç¡®è®¤ç­‰å¾…

**ä½ç½®**: `src/pages/Swap.tsx:116`

**é—®é¢˜**: äº¤æ˜“æäº¤åç«‹å³æ›´æ–° UIï¼Œæ²¡æœ‰ç­‰å¾…ç¡®è®¤

**è§£å†³æ–¹æ¡ˆ**:
```typescript
const txHash = await AAService.swapTokens(...)

// ã€æ·»åŠ ã€‘ç­‰å¾…äº¤æ˜“ç¡®è®¤
const receipt = await publicClient.waitForTransactionReceipt({
  hash: txHash,
  confirmations: 1
})

if (receipt.status === "reverted") {
  throw new Error("Transaction failed")
}

console.log('Swap Transaction Confirmed:', txHash)
```

---

### è­¦å‘Š 8: é”™è¯¯å¤„ç†ä½¿ç”¨ alert

**ä½ç½®**: `src/pages/Swap.tsx:135, 139`

**é—®é¢˜**: ä½¿ç”¨ `alert()` æ˜¾ç¤ºæ¶ˆæ¯ï¼Œç”¨æˆ·ä½“éªŒå·®

**è§£å†³æ–¹æ¡ˆ**:
ä½¿ç”¨ Toast ç»„ä»¶:
```typescript
// å®‰è£…: npm install react-hot-toast
import toast from 'react-hot-toast'

// æ›¿æ¢ alert
toast.success('Swap transaction submitted!')
toast.error(error.message || 'Swap failed')
```

---

### è­¦å‘Š 9: æ»‘ç‚¹ä¿æŠ¤å›ºå®šä¸º 5%

**ä½ç½®**: `src/pages/Swap.tsx:102`

**é—®é¢˜**: æ»‘ç‚¹å›ºå®šï¼Œç”¨æˆ·æ— æ³•è‡ªå®šä¹‰

**è§£å†³æ–¹æ¡ˆ**:
æ·»åŠ æ»‘ç‚¹è®¾ç½®:
```typescript
const [slippage, setSlippage] = useState(0.5) // é»˜è®¤ 0.5%

const amountOutMin = parseEther(
  (parseFloat(estimatedAmount) * (1 - slippage / 100)).toString()
)

// UI ä¸­æ·»åŠ æ»‘ç‚¹è®¾ç½®
<Select
  value={slippage.toString()}
  onChange={(v) => setSlippage(parseFloat(v))}
  options={[
    { value: "0.1", label: "0.1%" },
    { value: "0.5", label: "0.5%" },
    { value: "1", label: "1%" },
    { value: "5", label: "5%" },
  ]}
/>
```

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§ 1 (ç«‹å³ä¿®å¤ - å¦åˆ™åŠŸèƒ½æ— æ³•ä½¿ç”¨)
1. âœ… **ä¿®å¤ signer å˜é‡å£°æ˜** (é”™è¯¯ 1)

### ä¼˜å…ˆçº§ 2 (é‡è¦ - å½±å“ç”¨æˆ·ä½“éªŒ)
2. æ˜¾ç¤ºçœŸå®ä½™é¢ (è­¦å‘Š 3)
3. æ·»åŠ å®Œæ•´çš„ä½™é¢æ£€æŸ¥ (è­¦å‘Š 4)
4. æ·»åŠ  Gas è´¹æ‰£é™¤é€»è¾‘ (è­¦å‘Š 5)
5. éªŒè¯ sendTransactions æ–¹æ³• (è­¦å‘Š 2)

### ä¼˜å…ˆçº§ 3 (ä¼˜åŒ– - æå‡åŠŸèƒ½è´¨é‡)
6. ä»é“¾ä¸Šè·å–çœŸå®æ±‡ç‡ (è­¦å‘Š 6)
7. æ·»åŠ äº¤æ˜“ç¡®è®¤ç­‰å¾… (è­¦å‘Š 7)
8. æ”¹è¿›é”™è¯¯å¤„ç† (è­¦å‘Š 8)
9. æ·»åŠ æ»‘ç‚¹è®¾ç½® (è­¦å‘Š 9)

---

## ğŸ’¡ å¿«é€Ÿä¿®å¤ä»£ç 

### æœ€å°ä¿®å¤ (è®©åŠŸèƒ½èƒ½å¤Ÿè¿è¡Œ)

åœ¨ `src/pages/Swap.tsx` çš„ `handleSwap` å‡½æ•°ä¸­:

```typescript
const handleSwap = async () => {
  if (!network || !fromAsset || !toAsset) return
  setIsSwapping(true)

  try {
    const pk = getPrivateKey()
    if (!pk) throw new Error("No private key found")

    // ã€æ·»åŠ è¿™ä¸€è¡Œã€‘åˆ›å»º signer
    const signer = AAService.getSigner(pk as `0x${string}`)

    // ç°åœ¨å¯ä»¥æ­£å¸¸è°ƒç”¨äº†
    const txHash = await AAService.swapTokens(
      signer,
      PANCAKE_ROUTER,
      fromAsset.contractAddress || "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c",
      toAsset.contractAddress || "0x55d398326f99059fF775485246999027B3197955",
      amountWei,
      amountOutMin,
      deadline
    )

    console.log('Swap Transaction Submitted:', txHash)
    
    // ã€å»ºè®®æ·»åŠ ã€‘æ‰£é™¤ gas è´¹
    if (isActivated && parseFloat(finalFee) > 0) {
      updateAssetBalance(network.id, GAS_TOKEN_SYMBOL, finalFee, "subtract")
    }
    
    setAmount("")
    
    addActivity({
      type: "Swap",
      asset: `${fromAssetSymbol} -> ${toAssetSymbol}`,
      amount: `${amount} ${fromAssetSymbol}`,
      status: "Pending",
      hash: txHash,
      timestamp: Date.now()
    })

    alert(t('swap.success', 'Swap transaction submitted!'))

  } catch (error: any) {
    console.error("Swap failed", error)
    alert(error.message || "Swap failed")
  } finally {
    setIsSwapping(false)
  }
}
```

---

## âœ… æµ‹è¯•ç»“è®º

**å½“å‰çŠ¶æ€**: å…‘æ¢åŠŸèƒ½**æ— æ³•æ­£å¸¸ä½¿ç”¨**ï¼Œå› ä¸ºå­˜åœ¨ä¸¥é‡é”™è¯¯ (signer æœªå®šä¹‰)

**ä¿®å¤åçŠ¶æ€**: æ·»åŠ  `signer` å£°æ˜åï¼ŒåŠŸèƒ½å¯ä»¥åŸºæœ¬è¿è¡Œï¼Œä½†ä»éœ€è¦ä¼˜åŒ–:
- ä½™é¢æ˜¾ç¤ºå’Œæ£€æŸ¥
- Gas è´¹æ‰£é™¤
- çœŸå®æ±‡ç‡è·å–
- é”™è¯¯å¤„ç†æ”¹è¿›

**å»ºè®®**: ä¼˜å…ˆä¿®å¤é”™è¯¯ 1ï¼Œç„¶åé€æ­¥å®Œå–„è­¦å‘Š 3-5ï¼Œæœ€åä¼˜åŒ–è­¦å‘Š 6-9ã€‚
