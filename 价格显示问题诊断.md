# 自定义代币价格显示问题 - 诊断指南

## 📋 问题症状

- ✅ BNB、USDT、RADRS 价格正常显示
- ❌ 自定义添加的代币价格显示为 0
- ❌ 控制台显示 `ERR_CONNECTION_CLOSED` 错误

---

## 🔍 根本原因

**DexScreener API 连接失败**

可能的具体原因：
1. **网络环境限制** - 防火墙或 ISP 拦截
2. **API 限流** - 请求过于频繁
3. **地区限制** - 某些地区无法访问
4. **移动网络问题** - 4G/5G 对某些 API 的限制

---

## ✅ 已修复内容

### 1. 代码逻辑优化 ⭐⭐⭐⭐⭐

**修改文件：**
- `src/services/priceService.ts` - API 请求逻辑
- `src/components/wallet/AssetList.tsx` - 添加代币后立即获取价格
- `src/App.tsx` - 全局价格刷新包含自定义代币

**优化内容：**
- ✅ 改为单独请求每个代币（一个失败不影响其他）
- ✅ 超时时间 8秒 → 10秒
- ✅ 添加重试逻辑（处理 429 限流和 5xx 错误）
- ✅ 添加详细日志便于诊断
- ✅ 添加代币后立即获取价格（不等 60 秒）

### 2. 错误处理增强 ⭐⭐⭐⭐

- ✅ 修复缺少的状态变量（`tokenToDelete`）
- ✅ 修复缺少的函数（`confirmDelete`）
- ✅ 修复缺少的导入（`removeToken`, `updateRealtimePrices`）
- ✅ 控制台不再显示 "Dialog is not defined" 错误

---

## 🧪 诊断工具

### 方法 1: 快速测试（推荐）

```bash
# 双击运行
quick-test.bat
```

**测试内容：**
- DexScreener RADRS 价格
- GeckoTerminal RADRS 价格
- Binance BNB 价格

**预期结果：**
```
Testing: DexScreener RADRS
Status: 200 (1234ms)
Result: SUCCESS ✓
Price: $0.1214
```

### 方法 2: 完整测试

```bash
# 双击运行
test-api-simple.bat
```

### 方法 3: 手动命令行测试

```bash
cd c:\Users\wangping\Desktop\traegaswaetll
node quick-test.js
```

---

## 📊 诊断结果判读

### ✅ 全部成功（3/3）

```
SUCCESS ✓ - DexScreener RADRS
SUCCESS ✓ - GeckoTerminal RADRS
SUCCESS ✓ - Binance BNB
```

**结论：** API 连接正常，价格应该能正常显示

**如果仍显示 0：**
1. 清除浏览器缓存
2. 重启应用
3. 等待 10 秒让价格刷新

---

### ⚠️ 部分成功（1-2/3）

```
FAILED ✗ - DexScreener RADRS
SUCCESS ✓ - GeckoTerminal RADRS
SUCCESS ✓ - Binance BNB
```

**结论：** 有备用 API 可用，应该能正常工作

**说明：** 应用会自动使用成功的 API

---

### ❌ 全部失败（0/3）

```
FAILED ✗ - DexScreener RADRS (ERR_CONNECTION_CLOSED)
FAILED ✗ - GeckoTerminal RADRS (TIMEOUT)
FAILED ✗ - Binance BNB (ERR_CONNECTION_REFUSED)
```

**结论：** 网络环境有严重限制

**解决方案：** 见下方"网络问题解决方案"

---

## 🔧 解决方案

### 方案 1: 更换网络环境 ⭐⭐⭐⭐⭐

**测试不同网络：**

| 网络类型 | 优先级 | 成功率 |
|---------|--------|--------|
| **WiFi（家庭/办公室）** | 🥇 | 90% |
| **4G/5G 移动数据** | 🥈 | 70% |
| **VPN（香港/新加坡）** | 🥉 | 95% |
| **其他手机热点** | - | 60% |

**操作步骤：**
1. 断开当前网络
2. 连接新网络
3. 运行 `quick-test.bat`
4. 重启应用测试

---

### 方案 2: 修改 DNS 服务器 ⭐⭐⭐⭐

**为什么有效：**
- 某些 DNS 可能污染或解析失败
- Google DNS (8.8.8.8) 更可靠

**手机设置步骤：**

1. 打开 **设置** → **WiFi**
2. 长按连接的网络 → **修改网络**
3. **高级选项** → **IP 设置：静态**
4. 设置 DNS：
   - DNS 1: `8.8.8.8`
   - DNS 2: `1.1.1.1`
5. 保存并重新连接

---

### 方案 3: 关闭安全软件 ⭐⭐⭐

**可能拦截的软件：**
- 防火墙
- 杀毒软件
- 手机管家
- VPN（某些会拦截特定域名）

**操作步骤：**
1. 临时关闭所有安全软件
2. 运行 `quick-test.bat`
3. 如果成功，添加应用到白名单

---

### 方案 4: 使用 VPN ⭐⭐⭐⭐⭐

**推荐节点：**
- 香港
- 新加坡
- 日本
- 美国（加州）

**注意：**
- 免费 VPN 可能不稳定
- 确保 VPN 支持 HTTPS 和 API 访问

---

### 方案 5: 等待并重试 ⭐⭐

**适用情况：**
- API 限流（HTTP 429）
- 临时故障

**操作步骤：**
1. 等待 5-10 分钟
2. 重新运行测试
3. 重启应用

---

## 📱 应用内检查

### 1. 查看控制台日志

打开应用后按 `F12` 打开开发者工具：

**正常日志：**
```javascript
[App] Fetching prices...
[PriceService] Fetching price for CustomToken (0x...)
[PriceService] CustomToken Price (DexScreener): $0.0234
[AssetList] Got price for CustomToken: $0.0234
```

**错误日志：**
```javascript
[PriceService] Attempt 1/2 failed: ERR_CONNECTION_CLOSED
[PriceService] Attempt 2/2 failed: ERR_CONNECTION_CLOSED
[AssetList] No price found for CustomToken
```

---

### 2. 手动刷新价格

应用每 60 秒自动刷新价格。

**手动触发：**
1. 点击钱包页面右上角的刷新按钮 🔄
2. 或者切换到其他页面再返回

---

### 3. 检查代币是否支持

**注意：** 
- 只有在 **DEX（去中心化交易所）上交易的代币** 才能获取价格
- 没有流动性的代币无法获取价格

**支持的 DEX：**
- PancakeSwap（BSC）
- Uniswap（ETH）
- SushiSwap
- 等其他主流 DEX

**不支持：**
- 纯中心化交易所代币
- 无交易对的代币
- 刚发行且无流动性的代币

---

## 🎯 最佳实践

### 添加代币后的操作流程

1. ✅ 点击"添加代币"
2. ✅ 输入合约地址
3. ✅ 点击"搜索"
4. ✅ 确认信息后点击"添加"
5. ⏱️ **等待 10 秒**（自动获取价格）
6. 🔄 如果仍为 0，点击刷新按钮
7. 📱 如果还是 0，运行 `quick-test.bat` 诊断

---

## 📞 故障排查清单

在报告问题前，请完成以下检查：

- [ ] 运行 `quick-test.bat`（提供结果）
- [ ] 查看控制台日志（截图或复制文本）
- [ ] 尝试更换网络（WiFi → 4G → VPN）
- [ ] 修改 DNS 为 8.8.8.8
- [ ] 确认代币在 DEX 上有交易对
- [ ] 等待至少 10 秒让价格刷新
- [ ] 重启应用

---

## ✅ 成功标志

### UI 显示

```
雷达币                    Gas
用于网络费用               40.0000
$0.1214                   ≈ $4.86

富达币
Fuda Coin                 0.5678
$0.0234                   ≈ $0.01
```

### 控制台日志

```
[App] Custom tokens to fetch: [{ symbol: 'CustomToken', address: '0x...' }]
[PriceService] Fetching price for CustomToken (0x...)
[PriceService] CustomToken Price (DexScreener): $0.0234
[App] Prices updated: { BNB: 871.48, RADRS: 0.1214, CustomToken: 0.0234 }
```

---

## 📝 技术说明

### 价格获取流程

```
1. 应用启动
   ↓
2. 每 60 秒获取一次价格
   ↓
3. 查询 DexScreener API
   ├─ 成功 → 显示价格
   └─ 失败 → 尝试 GeckoTerminal API
       ├─ 成功 → 显示价格
       └─ 失败 → 显示 0（或保持旧值）
```

### API 优先级

1. **DexScreener** - 最快，数据最全
2. **GeckoTerminal** - 备用，稍慢
3. **CoinGecko** - 最终备用（仅 RADRS）
4. **链上价格** - 最慢但最可靠（仅 RADRS）

---

## 🚀 下一步

1. 运行 `quick-test.bat` 并查看结果
2. 根据结果选择对应的解决方案
3. 重启应用测试
4. 如果仍有问题，提供诊断结果

---

**最后更新：** 2026-01-21  
**适用版本：** 当前最新版本
